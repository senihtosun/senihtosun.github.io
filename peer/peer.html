<!DOCTYPE html>
<html lang="">
  <head>
    <meta charset="utf-8">
    <title> Peer JS </title>
    <script src="peerjs.min.js"></script>
  </head>
  <body>
  	<input type="text" id="callings"></input>
		<button class="button-call" onclick="call()">Call</button>
		<audio controls></audio>
		<div class="answerer-code">
			<button class="button-answ" onclick="answerer()">Answerer</button>
			<div id="peerid"></div>
		</div>
		<div class="bottom-space"></div>
	</div>
  </body>
  
  <script>
	
  	let peer = new Peer({
		host: 'https://9000-f585e490-611e-4c6d-95c2-65285d567841.ws-us02.gitpod.io',
		port: '443',
		path: '/',
		secure: true
	});

  	peer.on('open', function(id) {
  		console.log('My peer ID is: ' + id);
	}); 
	  
	  var getUserMedia = (function () {
			if (navigator.getUserMedia) {
				return navigator.getUserMedia.bind(navigator)
			}
			if (navigator.webkitGetUserMedia) {
				return navigator.webkitGetUserMedia.bind(navigator)
			}
			if (navigator.mozGetUserMedia) {
				return navigator.mozGetUserMedia.bind(navigator)
			}
		})();

		function onReceiveStream(stream) {
			var audio = document.querySelector('audio');
			console.log(audio);
			audio.srcObject = stream;
			audio.onloadedmetadata = function (e) {
				console.log('now playing the audio');
				audio.play();
			}
		}

		function call() {
			var person_to_call = document.getElementById('callings').value;
			console.log('WE IS CALLINNNN BRO ' + person_to_call);
			var peer = new Peer();
			getUserMedia({
				video: false,
				audio: true
			}, function (stream) {
				var call = peer.call(person_to_call, stream);
				call.on('stream', function (remoteStream) {
					console.log(remoteStream);
					onReceiveStream(remoteStream);
					// Show stream in some video/canvas element.
				});
			}, function (err) {
				console.log('Failed to get local stream', err);
			});

		}

		function answerer() {
			var peer = new Peer();
			peer.on('open', (id) => {
				document.getElementById('peerid').innerHTML = id;
			});
			peer.on('call', function (call) {
				getUserMedia({
					video: false,
					audio: true
				}, function (stream) {
					console.log("WE IS GETTIN CALLEDDDD");
					call.answer(stream); // Answer the call with an A/V stream.
					call.on('stream', function (remoteStream) {
						console.log(remoteStream);
						onReceiveStream(remoteStream);
						// Show stream in some video/canvas element.
					});
				}, function (err) {
					console.log('Failed to get local stream', err);
				});
			});
		}

  </script>
</html>
