<html>

<head>
	<title>VoiceApp is phone calls for your web browser</title>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
</head>

<body>
	<div class="text-center">
        <h1> Pirify Peer to Peer Chat </h1> <br>

		<input type="text" id="id_to_call">
        
        <button class="btn btn-dark" onclick="call()">Call</button> <br><br>
		<audio controls></audio>
        <br><br>
        <button class="btn btn-dark" onclick="answer()">Answer</button> <br><br>
        <label id='peerid'></label> <br>
		
	</div>
	<script src="peerjs.min.js"></script>
    
    <script>

		var getUserMedia = (function () {
			if (navigator.getUserMedia) {
				return navigator.getUserMedia.bind(navigator)
			}
			if (navigator.webkitGetUserMedia) {
				return navigator.webkitGetUserMedia.bind(navigator)
			}
			if (navigator.mozGetUserMedia) {
				return navigator.mozGetUserMedia.bind(navigator)
			}
		})();

		function onReceiveStream(stream) {
			var audio = document.querySelector('audio');
			audio.srcObject = stream;
			audio.onloadedmetadata = (e) => {
				console.log('Call established');
				audio.play();
			}
		}

		function call() {
			var id_to_call = document.getElementById('id_to_call').value;
			console.log('You are calling ' + id_to_call);
			var peer = new Peer({
                host: 'senihpeer2peer.herokuapp.com',
                port: 443,
                path: '/myapp',
                secure: true,
            });

            let message = '<br>Share this ID with a peer to connect'

            peer.on('open', (id) => {
                document.getElementById('peerid').innerHTML = 'Your ID is ' + id + message;
            }) 

			getUserMedia({
				video: false,
				audio: true
			}, function (stream) {
				var call = peer.call(id_to_call, stream);
				call.on('stream', function (remoteStream) {
					console.log(remoteStream);
					onReceiveStream(remoteStream);
					// Show stream in some video/canvas element.
				});
			}, function (err) {
				console.log('Failed to get local stream', err);
			});

		}

		function answer() {
			var peer = new Peer({
                host: 'senihpeer2peer.herokuapp.com',
                port: 443,
                path: '/myapp',
                secure: true,
            });

            let message = '<br>Share this ID with a peer to connect'

			peer.on('open', (id) => {
                document.getElementById('peerid').innerHTML = 'Your ID is ' + id + message;
			});

			peer.on('call', function (call) {
				getUserMedia({
					video: false,
					audio: true
				}, function (stream) {
					console.log("You are getting called");
					call.answer(stream); // Answer the call with an A/V stream.
					call.on('stream', function (remoteStream) {
						console.log(remoteStream);
						onReceiveStream(remoteStream);
						// Show stream in some video/canvas element.
					});
				}, function (err) {
					console.log('Failed to get local stream', err);
				});
			});
		}
	</script>

</body>

</html>
